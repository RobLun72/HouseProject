using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using HouseService.Services;
using HouseService.Data;
using HouseService.Models;

namespace HouseService.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class RoomController : ControllerBase
    {
        private readonly HouseDbContext _context;
        private readonly ILogger<RoomController> _logger;
        private readonly IMessagePublisher _messagePublisher;

        public RoomController(HouseDbContext context, ILogger<RoomController> logger, IMessagePublisher messagePublisher)
        {
            _context = context;
            _logger = logger;
            _messagePublisher = messagePublisher;
        }

        [HttpGet]
        public async Task<ActionResult<IEnumerable<Room>>> GetRooms()
        {
            return Ok(await _context.Rooms.ToListAsync());
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<Room>> GetRoom(int id)
        {
            var room = await _context.Rooms.FindAsync(id);
            if (room == null)
            {
                return NotFound();
            }
            return Ok(room);
        }

        [HttpGet("house/{houseId}")]
        public async Task<ActionResult<IEnumerable<Room>>> GetRoomsByHouse(int houseId)
        {
            var rooms = await _context.Rooms
                .Where(r => r.HouseId == houseId)
                .ToListAsync();
            return Ok(rooms);
        }

        [HttpPost]
        public async Task<ActionResult<Room>> CreateRoom(CreateRoomRequest request)
        {
            if (request == null)
            {
                return BadRequest();
            }

            // Verify the house exists
            var house = await _context.Houses.FindAsync(request.HouseId);
            if (house == null)
            {
                return BadRequest("House not found");
            }

            var room = new Room
            {
                HouseId = request.HouseId,
                Name = request.Name,
                Type = request.Type,
                Area = request.Area,
                Placement = request.Placement
                // RoomId will be auto-generated by the database
            };

            _context.Rooms.Add(room);
            await _context.SaveChangesAsync();
            
            // Publish RoomCreated event
            await _messagePublisher.PublishRoomCreatedAsync(room.RoomId, room.HouseId, room.Name, room.Type, room.Area);
            
            return CreatedAtAction(nameof(GetRoom), new { id = room.RoomId }, room);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateRoom(int id, UpdateRoomRequest request)
        {
            if (request == null)
            {
                return BadRequest();
            }

            var room = await _context.Rooms.FindAsync(id);
            if (room == null)
            {
                return NotFound();
            }

            // Verify the house exists
            var house = await _context.Houses.FindAsync(request.HouseId);
            if (house == null)
            {
                return BadRequest("House not found");
            }

            // Update the room properties from the request
            room.HouseId = request.HouseId;
            room.Name = request.Name;
            room.Type = request.Type;
            room.Area = request.Area;
            room.Placement = request.Placement;

            _context.Entry(room).State = EntityState.Modified;

            try
            {
                await _context.SaveChangesAsync();
                
                // Publish RoomUpdated event
                await _messagePublisher.PublishRoomUpdatedAsync(room.RoomId, room.HouseId, room.Name, room.Type, room.Area);
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!await RoomExists(id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }
            
            return NoContent();
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteRoom(int id)
        {
            var room = await _context.Rooms.FindAsync(id);
            if (room == null)
            {
                return NotFound();
            }

            var houseId = room.HouseId; // Store before deletion
            _context.Rooms.Remove(room);
            await _context.SaveChangesAsync();
            
            // Publish RoomDeleted event
            await _messagePublisher.PublishRoomDeletedAsync(id, houseId);
            
            return NoContent();
        }

        private async Task<bool> RoomExists(int id)
        {
            return await _context.Rooms.AnyAsync(e => e.RoomId == id);
        }
    }
}